#!/bin/bash

# GET LOCATION OF ZIP FILE

# Either from 1st param or from user input
# Don't want to do other work if this is not in place

zip_file=$1

if [ ! $zip_file ]
then
    echo 'Please pass the path to the drivers.zip file'
    echo "If you don't have it, type CTRL-C to exit"

    read zip_file
fi

if [ ! -f $zip_file ]
then
    echo "Zip file ($zip_file) does not exist" >&2
    exit 1
fi

# SET UP DATA

# (data) is easier to type / read than (DTA_DATA)
data=$DTA_DATA

# Make data dir if it doesn't exist
if [ ! -d $data ]
then
    mkdir $data
fi

# Some convenience vars
drivers=$data/drivers
driver=$data/driver

# If we haven't done this already, unzip
# the zip file to the data directory
if [[ ! -d $drivers  && ! -d $driver ]]
then
    unzip -q $zip_file -d $data
fi

# Exit script if any command fails (
#   We couldn't do this before because the
#   zip file is malformed and exits non-zero
# )

set -e
set -o pipefail

###############################################
# I'm creating a directory structure suitable #
#           for a RESTful API.                #
#                                             #
#       /driver/$x/trip/$y/some-file          #
###############################################

# drivers/$x/{1..200}.csv --> driver/$x/trip/$y/coordinates-cartesian

if [ ! -d $driver ]
then
    mv $drivers $driver
fi


for driver in $driver/*
do
    if [ ! -d $driver/trip ]
    then
        mkdir $driver/trip
    fi

    for i in {1..200} # can assume that each driver has 200 trips
    do
        driver_trip=$driver/trip/$i

        if [ ! -f $driver_trip/coordinates-cartesian ]
        then
            csv=$driver/$i.csv

            if [ -f $csv ]
            then
                if [ ! -d $driver_trip ]
                then
                    mkdir $driver_trip
                fi

                sed -n '2,$p' $csv > $driver_trip/coordinates-cartesian # Strip the header
                rm $csv
            else
                echo "Neither ($driver_trip/coordinates-cartesian) nor ($csv) exists" >&2
                echo "Expected one or the other" >&2
                exit 1
            fi
        fi
    done
done


# Create a symolic link so the webapp
# can find the driver data

if [ ! -h public/driver ]
then
    ln -s $DTA_DATA/driver public/driver
fi
